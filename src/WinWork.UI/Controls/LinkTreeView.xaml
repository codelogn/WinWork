<UserControl x:Class="WinWork.UI.Controls.LinkTreeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="400" d:DesignWidth="300">
    
    <UserControl.Resources>
        <!-- Tree View Item Template -->
        <HierarchicalDataTemplate x:Key="LinkTreeItemTemplate" ItemsSource="{Binding Children}">
            <Grid Margin="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Icon -->
                <Border Grid.Column="0" 
                        Background="{Binding IconBackground}" 
                        CornerRadius="3" 
                        Width="16" Height="16" 
                        Margin="0,0,8,0">
                    <TextBlock Text="{Binding Icon}" 
                               Foreground="White" 
                               FontSize="10" 
                               FontWeight="Bold"
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center"/>
                </Border>
                
                <!-- Link Name -->
                <TextBlock Grid.Column="1" 
                           Text="{Binding Name}" 
                           Foreground="White"
                           FontSize="13"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>
                
                <!-- Tags -->
                <ItemsControl Grid.Column="2" 
                              ItemsSource="{Binding Tags}" 
                              Margin="8,0,0,0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{Binding Color}" 
                                    CornerRadius="8" 
                                    Padding="4,2" 
                                    Margin="2,0">
                                <TextBlock Text="{Binding Name}" 
                                           Foreground="White" 
                                           FontSize="9"
                                           FontWeight="Medium"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </HierarchicalDataTemplate>

        <!-- Tree View Item Container Style -->
        <Style x:Key="ModernTreeViewItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="Margin" Value="0,1"/>
            <Setter Property="AllowDrop" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TreeViewItem">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Item Content -->
                            <Border x:Name="ItemBorder"
                                    Grid.Row="0"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Expander -->
                                    <ToggleButton x:Name="Expander"
                                                  Grid.Column="0"
                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                  ClickMode="Press"
                                                  Background="Transparent"
                                                  BorderThickness="0"
                                                  Width="16" Height="16"
                                                  Margin="0,0,4,0">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Grid Background="Transparent">
                                                    <Path x:Name="ExpandPath"
                                                          Fill="White"
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center"
                                                          Data="M 4,0 L 8,4 L 4,8 Z"/>
                                                </Grid>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsChecked" Value="True">
                                                        <Setter TargetName="ExpandPath" Property="Data" Value="M 0,4 L 4,8 L 8,4 Z"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                    
                                    <!-- Content -->
                                    <ContentPresenter x:Name="PART_Header"
                                                      Grid.Column="1"
                                                      ContentSource="Header"
                                                      HorizontalAlignment="Left"
                                                      VerticalAlignment="Center"/>
                                </Grid>
                            </Border>
                            
                            <!-- Children -->
                            <ItemsPresenter x:Name="ItemsHost"
                                            Grid.Row="1"
                                            Margin="16,0,0,0"/>
                        </Grid>
                        
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="False">
                                <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                            </Trigger>
                            <Trigger Property="HasItems" Value="False">
                                <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="ItemBorder" Property="Background" Value="#4DFFFFFF"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ItemBorder" Property="Background" Value="#33FFFFFF"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsSelected" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="ItemBorder" Property="Background" Value="#66FFFFFF"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <EventSetter Event="MouseMove" Handler="TreeViewItem_MouseMove"/>
        </Style>
    </UserControl.Resources>
    
    <Border Background="#1A000000" 
            CornerRadius="8" 
            BorderBrush="#33FFFFFF" 
            BorderThickness="1">
        
        <TreeView x:Name="TreeView"
                  ItemsSource="{Binding ItemsSource, RelativeSource={RelativeSource AncestorType=UserControl}}"
                  ItemTemplate="{StaticResource LinkTreeItemTemplate}"
                  ItemContainerStyle="{StaticResource ModernTreeViewItemStyle}"
                  Background="Transparent"
                  BorderThickness="0"
                  Padding="8"
                  AllowDrop="True"
                  MouseDoubleClick="TreeView_MouseDoubleClick"
                  MouseRightButtonDown="TreeView_MouseRightButtonDown"
                  Drop="TreeView_Drop"
                  DragOver="TreeView_DragOver">
            
            <TreeView.ContextMenu>
                <ContextMenu Background="#CC000000" 
                             BorderBrush="#33FFFFFF" 
                             BorderThickness="1" 
                             x:Name="TreeViewContextMenu">
                    <MenuItem Header="Add Item" 
                              Foreground="White" 
                              Click="AddLink_Click"/>
                    <MenuItem Header="Add Folder" 
                              Foreground="White" 
                              Click="AddFolder_Click"/>
                    <Separator Background="#33FFFFFF"/>
                    <MenuItem Header="Edit" 
                              Foreground="White" 
                              Command="{Binding EditCommand}"/>
                    <MenuItem Header="Delete" 
                              Foreground="White" 
                              Command="{Binding DeleteCommand}"/>
                    <Separator Background="#33FFFFFF"/>
                    <MenuItem Header="Copy URL" 
                              Foreground="White" 
                              Command="{Binding CopyUrlCommand}"/>
                    <MenuItem Header="Open in Browser" 
                              Foreground="White" 
                              Command="{Binding OpenInBrowserCommand}"/>
                </ContextMenu>
            </TreeView.ContextMenu>
        </TreeView>
    </Border>
</UserControl>
